// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum StockTxnType {
  INBOUND // รับเข้า (GRN, Return-to-stock)
  OUTBOUND // จ่ายออก (Shipment)
  RESERVE // จอง
  RELEASE // คืนจอง
  TRANSFER_OUT // โอนออก
  TRANSFER_IN // โอนเข้า
  ADJUST // ปรับยอด
}

enum DocStatus {
  DRAFT
  APPROVED
  SENT
  PARTIAL
  CLOSED
  CANCELLED
  RECEIVED
}

model User {
  id            String  @id @default(cuid())
  email         String  @unique
  name          String?
  image         String?
  emailVerified Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Better Auth relations
  sessions Session[]
  accounts Account[]

  roles     UserRole[]
  auditLogs AuditLog[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

model Role {
  id          String           @id @default(cuid())
  code        String           @unique
  name        String
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id    String           @id @default(cuid())
  code  String           @unique // e.g. INVENTORY_ADJUST, PO_APPROVE
  name  String
  roles RolePermission[]
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model Category {
  id       String            @id @default(cuid())
  name     String
  slug     String            @unique
  products ProductCategory[]
}

model Product {
  id          String   @id @default(cuid())
  title       String
  description String?
  brand       String?
  status      String   @default("ACTIVE") // ACTIVE/ARCHIVED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variants   ProductVariant[]
  images     ProductImage[]
  categories ProductCategory[]
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  sku       String   @unique
  barcode   String?
  color     String?
  size      String?
  price     Decimal
  cost      Decimal?
  isActive  Boolean  @default(true)

  product       Product             @relation(fields: [productId], references: [id])
  orderItems    SalesOrderItem[]
  poItems       PurchaseOrderItem[]
  grnItems      GoodsReceiptItem[]
  stockTxns     InventoryTxn[]
  reservations  StockReservation[]
  transferItems StockTransferItem[]
  returnItems   ReturnItem[]
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  sortOrder Int     @default(0)
  product   Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model ProductCategory {
  productId  String
  categoryId String
  product    Product  @relation(fields: [productId], references: [id])
  category   Category @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
}

model Warehouse {
  id           String             @id @default(cuid())
  code         String             @unique
  name         String
  createdAt    DateTime           @default(now())
  locations    Location[]
  stockTxns    InventoryTxn[]
  reservations StockReservation[]

  goodsReceipts GoodsReceipt[]
}

model Location {
  id          String    @id @default(cuid())
  warehouseId String
  code        String // e.g. A-01-02
  name        String?
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  stockTxns InventoryTxn[]

  @@unique([warehouseId, code])
}

model InventoryTxn {
  id          String       @id @default(cuid())
  type        StockTxnType
  variantId   String
  warehouseId String
  locationId  String?
  qty         Int // positive number; meaning depends on type
  unitCost    Decimal?
  refType     String? // "PO","GRN","SO","TRANSFER","ADJUST","RMA"
  refId       String? // document id
  note        String?
  createdById String?
  createdAt   DateTime     @default(now())

  variant   ProductVariant @relation(fields: [variantId], references: [id])
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id])
  location  Location?      @relation(fields: [locationId], references: [id])
}

model StockReservation {
  id          String   @id @default(cuid())
  orderId     String
  variantId   String
  warehouseId String
  qty         Int
  status      String   @default("ACTIVE") // ACTIVE/RELEASED/CONSUMED
  createdAt   DateTime @default(now())

  order     SalesOrder     @relation(fields: [orderId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id])

  @@index([orderId])
}

model Supplier {
  id    String          @id @default(cuid())
  name  String
  email String?
  phone String?
  pos   PurchaseOrder[]
}

model PurchaseOrder {
  id         String    @id @default(cuid())
  code       String    @unique
  supplierId String
  status     DocStatus @default(DRAFT)
  expectedAt DateTime?
  note       String?
  createdAt  DateTime  @default(now())

  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]
  receipts GoodsReceipt[]
}

model PurchaseOrderItem {
  id        String  @id @default(cuid())
  poId      String
  variantId String
  qty       Int
  unitCost  Decimal

  po      PurchaseOrder  @relation(fields: [poId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([poId])
}

model GoodsReceipt {
  id          String    @id @default(cuid())
  code        String    @unique
  poId        String?
  warehouseId String
  status      DocStatus @default(RECEIVED)
  receivedAt  DateTime  @default(now())
  note        String?

  po        PurchaseOrder?     @relation(fields: [poId], references: [id])
  warehouse Warehouse          @relation(fields: [warehouseId], references: [id])
  items     GoodsReceiptItem[]
}

model GoodsReceiptItem {
  id        String  @id @default(cuid())
  grnId     String
  variantId String
  qty       Int
  unitCost  Decimal

  grn     GoodsReceipt   @relation(fields: [grnId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([grnId])
}

model SalesOrder {
  id         String   @id @default(cuid())
  code       String   @unique
  status     String   @default("PENDING_PAYMENT")
  customerId String? // future
  createdAt  DateTime @default(now())

  items        SalesOrderItem[]
  reservations StockReservation[]
  returns      ReturnCase[]
}

model SalesOrderItem {
  id        String  @id @default(cuid())
  orderId   String
  variantId String
  qty       Int
  unitPrice Decimal

  order   SalesOrder     @relation(fields: [orderId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
}

model StockTransfer {
  id              String    @id @default(cuid())
  code            String    @unique
  fromWarehouseId String
  toWarehouseId   String
  status          DocStatus @default(DRAFT)
  createdAt       DateTime  @default(now())

  items StockTransferItem[]
}

model StockTransferItem {
  id         String @id @default(cuid())
  transferId String
  variantId  String
  qty        Int

  transfer StockTransfer  @relation(fields: [transferId], references: [id])
  variant  ProductVariant @relation(fields: [variantId], references: [id])

  @@index([transferId])
}

model ReturnCase {
  id        String   @id @default(cuid())
  orderId   String
  status    String   @default("REQUESTED") // REQUESTED/RECEIVED/COMPLETED
  createdAt DateTime @default(now())

  order SalesOrder   @relation(fields: [orderId], references: [id])
  items ReturnItem[]
}

model ReturnItem {
  id          String @id @default(cuid())
  returnId    String
  variantId   String
  qty         Int
  disposition String @default("RESTOCK") // RESTOCK/DAMAGED

  rma     ReturnCase     @relation(fields: [returnId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String // e.g. "INVENTORY_ADJUST_CREATED"
  entity    String // e.g. "InventoryTxn"
  entityId  String?
  meta      Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model Menus {
  id        String   @id @default(cuid())
  name      String
  items     Json
  icon      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subMenus SubMenus[]
}

model SubMenus {
  id        String   @id @default(cuid())
  name      String
  items     Json
  icon      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  menuId    String

  menu Menus @relation(fields: [menuId], references: [id])
}
